<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - A2Z Learning</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">A2Z Learning</div>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/progress">Progress</a>
                <a href="/profile">Profile</a>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </nav>
    </header>

    <div class="container">
        <h1 class="text-center mb-3">My Profile</h1>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <!-- Profile Info -->
            <div class="form-container" style="margin: 0;">
                <h2 class="mb-2">Profile Information</h2>
                <div id="alert" class="hidden"></div>
                
                <form id="profileForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn">Update Profile</button>
                </form>
            </div>

            <!-- Password Change -->
            <div class="form-container" style="margin: 0;">
                <h2 class="mb-2">Change Password</h2>
                <div id="passwordAlert" class="hidden"></div>
                
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" class="form-control" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn">Change Password</button>
                </form>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-number" id="totalCompleted">0</span>
                <span class="stat-label">Tasks Completed</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="roadmapsStarted">0</span>
                <span class="stat-label">Roadmaps Started</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="overallProgress">0%</span>
                <span class="stat-label">Overall Progress</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="memberSince">2024</span>
                <span class="stat-label">Member Since</span>
            </div>
        </div>

        <div class="text-center mt-2">
            <a href="/dashboard" class="btn btn-outline">Back to Dashboard</a>
        </div>
    </div>

    <script>
        let currentUser = null;

        function showAlert(message, type, alertId = 'alert') {
            const alert = document.getElementById(alertId);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('hidden');
        }

        async function loadProfile() {
            try {
                // Get current user
                const userResponse = await fetch('/api/user');
                currentUser = await userResponse.json();
                
                // Fill form
                document.getElementById('name').value = currentUser.name;
                document.getElementById('email').value = currentUser.email;

                // Load stats
                const roadmapsResponse = await fetch('/api/roadmaps');
                const roadmaps = await roadmapsResponse.json();

                let totalCompleted = 0;
                let roadmapsStarted = 0;

                for (const roadmap of roadmaps) {
                    const progressResponse = await fetch(`/api/progress/${roadmap.id}`);
                    const progress = await progressResponse.json();
                    totalCompleted += progress.length;
                    if (progress.length > 0) roadmapsStarted++;
                }

                const totalTasks = roadmaps.reduce((sum, roadmap) => 
                    sum + roadmap.modules.reduce((moduleSum, module) => moduleSum + module.tasks.length, 0), 0
                );
                const overallPercentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;

                document.getElementById('totalCompleted').textContent = totalCompleted;
                document.getElementById('roadmapsStarted').textContent = roadmapsStarted;
                document.getElementById('overallProgress').textContent = `${overallPercentage}%`;

            } catch (error) {
                console.error('Failed to load profile:', error);
                showAlert('Failed to load profile data', 'error');
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            
            // Mock update - in real implementation would call API
            showAlert('Profile updated successfully!', 'success');
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error', 'passwordAlert');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('Password must be at least 6 characters long', 'error', 'passwordAlert');
                return;
            }
            
            // Mock update - in real implementation would call API
            document.getElementById('passwordForm').reset();
            showAlert('Password changed successfully!', 'success', 'passwordAlert');
        });

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        // Load profile when page loads
        loadProfile();
    </script>
</body>
</html>
