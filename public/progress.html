<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress - A2Z Learning</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">A2Z Learning</div>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/progress">Progress</a>
                <a href="/profile">Profile</a>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </nav>
    </header>

    <div class="container">
        <h1 class="text-center mb-3">My Learning Progress</h1>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-number" id="totalCompleted">0</span>
                <span class="stat-label">Tasks Completed</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalRoadmaps">0</span>
                <span class="stat-label">Roadmaps Started</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="overallProgress">0%</span>
                <span class="stat-label">Overall Progress</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="streak">5</span>
                <span class="stat-label">Day Streak</span>
            </div>
        </div>

        <h2 class="mb-2">Roadmap Progress</h2>
        <div id="progressGrid" class="roadmap-grid">
            <!-- Progress cards will be loaded here -->
        </div>

        <div class="text-center mt-2">
            <a href="/dashboard" class="btn btn-outline">Back to Dashboard</a>
        </div>
    </div>

    <script>
        let roadmaps = [];
        let allProgress = {};

        async function loadProgress() {
            try {
                // Get roadmaps
                const roadmapsResponse = await fetch('/api/roadmaps');
                roadmaps = await roadmapsResponse.json();

                // Get progress for each roadmap
                for (const roadmap of roadmaps) {
                    const progressResponse = await fetch(`/api/progress/${roadmap.id}`);
                    allProgress[roadmap.id] = await progressResponse.json();
                }

                updateStats();
                renderProgress();
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        function updateStats() {
            const totalCompleted = Object.values(allProgress).flat().length;
            const roadmapsStarted = Object.keys(allProgress).filter(id => allProgress[id].length > 0).length;
            
            const totalTasks = roadmaps.reduce((sum, roadmap) => 
                sum + roadmap.modules.reduce((moduleSum, module) => moduleSum + module.tasks.length, 0), 0
            );
            const overallPercentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;

            document.getElementById('totalCompleted').textContent = totalCompleted;
            document.getElementById('totalRoadmaps').textContent = roadmapsStarted;
            document.getElementById('overallProgress').textContent = `${overallPercentage}%`;
        }

        function renderProgress() {
            const grid = document.getElementById('progressGrid');
            
            grid.innerHTML = roadmaps.map(roadmap => {
                const totalTasks = roadmap.modules.reduce((sum, module) => sum + module.tasks.length, 0);
                const completedTasks = allProgress[roadmap.id]?.length || 0;
                const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                return `
                    <div class="roadmap-card">
                        <div class="roadmap-title">${roadmap.title}</div>
                        <div class="roadmap-meta">
                            <span class="badge badge-${roadmap.difficulty.toLowerCase()}">${roadmap.difficulty}</span>
                            <span style="color: #666;">${roadmap.duration}</span>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="progress-text">
                            ${completedTasks}/${totalTasks} tasks completed (${progressPercentage}%)
                        </div>
                        
                        ${progressPercentage > 0 ? `
                            <div style="margin-top: 1rem;">
                                <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Module Progress:</h4>
                                ${roadmap.modules.map(module => {
                                    const moduleProgress = allProgress[roadmap.id]?.filter(taskId => 
                                        module.tasks.some(task => task.id === taskId)
                                    ).length || 0;
                                    const moduleTotal = module.tasks.length;
                                    const modulePercentage = moduleTotal > 0 ? Math.round((moduleProgress / moduleTotal) * 100) : 0;
                                    
                                    return `
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.25rem;">
                                            <span style="color: #666;">${module.title}</span>
                                            <span>${moduleProgress}/${moduleTotal} (${modulePercentage}%)</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        <a href="/roadmap/${roadmap.id}" class="btn" style="margin-top: 1rem; width: 100%;">
                            ${progressPercentage > 0 ? 'Continue' : 'Start'} Learning
                        </a>
                    </div>
                `;
            }).join('');
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        // Load progress when page loads
        loadProgress();
    </script>
</body>
</html>
